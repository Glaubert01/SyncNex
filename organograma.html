<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SyncNex - CSN</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="assets/syncnex-favicon.png">
  <style>
    :root{
      --line:#2a5f8a;
      --line-dark:#7fb3ff;
    }

    /* √Årea do organograma */
    .org-wrapper{
      padding:12px;
      overflow-x:hidden;   /* nunca mostra rolagem horizontal */
      max-width:100%;
    }
    /* Cont√™iner externo que recebe largura visual para centralizar o scale */
    .fitouter{
      margin:0 auto;           /* centraliza visualmente */
      width:max-content;       /* ser√° ajustado via JS para largura visual */
    }
    /* Caixa que √© escalada */
    .fitbox{
      transform-origin: top left;     /* evita ‚Äúcorte‚Äù em lados */
      display:block;
      width:max-content;              /* fica com a largura natural para medi√ß√£o */
    }

    .org-root{display:flex;flex-direction:column;align-items:center;gap:22px}

    .org-card{
      min-width:160px; max-width:240px; text-align:center;
      background:var(--card-bg, #e7f2fb); color:var(--card-fg, #0b3a5b);
      border-radius:14px; padding:12px; font-weight:700;
      box-shadow:0 1px 0 rgba(0,0,0,.08), 0 6px 14px rgba(0,0,0,.06);
    }
    .org-person{cursor:pointer; user-select:none; position:relative;}
    .org-person .chev{font-weight:900; opacity:.9; margin-left:6px}

    .org-subcard{
      background:#fff; color:#2b2b2b; border-radius:12px; padding:10px 12px;
      font-weight:600; box-shadow:0 1px 0 rgba(0,0,0,.06);
      width:260px; max-width:92vw;
    }
    .org-activity{font-weight:500; margin-top:8px; padding:8px 10px; border-radius:10px; background:#f6f7fb}

    .editable[contenteditable="true"]{outline:2px dashed #88a; border-radius:6px; padding:2px 4px}
    .xbtn{margin-left:6px; cursor:pointer}

    /* Conectores refor√ßados */
    .connector-v{
      width:6px; background:var(--line); height:28px; margin:2px auto; border-radius:3px;
      box-shadow:0 0 0 1px rgba(0,0,0,.03);
    }
    .stack{display:flex; flex-direction:column; align-items:center; gap:16px; margin-top:8px}
    .stack .connector-v{height:18px}

    /* Linha horizontal (decorativa) */
    .rail{ width:100%; height:6px; background:var(--line); border-radius:4px; opacity:.45; }

    /* Pessoas SEMPRE em uma √∫nica linha (nowrap) */
    .people-row{
      display:flex; flex-wrap:nowrap; gap:32px; justify-content:center; align-items:flex-start;
      width:max-content;                 /* largura natural para medi√ß√£o */
    }
    .person-col{display:flex; flex-direction:column; align-items:center; padding:0 4px}

    /* Dark mode */
    body.dark-mode .org-card{--card-bg:#124c74; --card-fg:#e6f0f7}
    body.dark-mode .org-subcard{background:#1e2b36; color:#e6f0f7}
    body.dark-mode .org-activity{background:#16222c; color:#cfe2f3}
    body.dark-mode .connector-v, body.dark-mode .rail{background:var(--line-dark)}

    .label-muted{font-size:11px; font-weight:600; opacity:.9; letter-spacing:.04em}

    /* Colaps√°vel */
    .collapse{ overflow:hidden; transition:max-height .28s ease; width:100%; display:block; }
  </style>
</head>
<body>
  <button id="toggle-mode" class="darkmode-btn" title="Alternar modo escuro">üåì</button>
  <button class="menu-toggle" id="menu-toggle" aria-label="Abrir menu">&#9776;</button>

  <div class="container">
    <aside class="sidebar" id="sidebar">
      <a href="index.html">
        <img src="assets/logo-csn.png" alt="Logo CSN" class="logo-csn" />
      </a>
      <ul class="menu">
        <li><a href="absenteismo.html">Absenteismo</a></li>
        <li><a href="contratos.html">Contratos</a></li>
        <li><a href="dgfm.html">DGFM</a></li>
        <li><a href="diesel.html">Diesel</a></li>
        <li><a href="efetivo.html">Efetivo</a></li>
        <li><a href="horaextra.html">Horas Extras</a></li>
        <li><a href="kanban.html">Kanban</a></li>
        <li><a href="mapa.html">Mapa</a></li>
        <li class="menu__item"><a href="milk.html">Milk Run</a></li>
        <li><a href="mttr.html">MTTR</a></li>
        <li><a href="mtbf.html">MTBF</a></li>
        <li class="menu__item"><a href="organograma.html">Organograma</a></li>
        <li><a href="projetos.html">Projetos</a></li>
        <li><a href="sobressalentes.html">Sobressalentes</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <h2 class="titulo">Organograma de Atividades Staffs GIL</h2>

      <div id="organograma" class="org-wrapper">
        <!-- JS injeta .fitouter > .fitbox aqui -->
      </div>

      <div class="controls">
        <button id="edit-mode-btn" onclick="toggleEditMode()">Editar</button>
        <button onclick="addPessoa()">Adicionar Pessoa</button>
        <button onclick="addPilar()">Adicionar Pilar</button>
        <button onclick="salvar()">Salvar</button>
      </div>
    </main>
  </div>

  <script>
    let editMode = false;

    // Estado principal
    let data = JSON.parse(localStorage.getItem("organograma")) || {
      pessoas: ["Glaubert", "Sergio", "Daiana"],
      pilares: ["Pilar A", "Pilar B", "Pilar C"],
      atividades: [
        ["Atividade A1", "Atividade A2", "Atividade A3"],
        ["Atividade B1", "Atividade B2", "Atividade B3"],
        ["Atividade C1", "Atividade C2", "Atividade C3"]
      ]
    };

    // Estado de colapso por pessoa (persiste)
    let colapso = JSON.parse(localStorage.getItem("org-colapso")) || {};
    function persistCollapse(){ localStorage.setItem("org-colapso", JSON.stringify(colapso)); }

    // --------- RENDER ----------
    function renderChart() {
      const wrapper = document.getElementById("organograma");
      wrapper.innerHTML = "";

      // Cont√™iner externo e a caixa escal√°vel
      const outer = document.createElement("div");
      outer.id = "fitouter";
      outer.className = "fitouter";

      const fitbox = document.createElement("div");
      fitbox.id = "fitbox";
      fitbox.className = "fitbox";

      const root = document.createElement("div");
      root.className = "org-root";

      const topo = document.createElement("div");
      topo.className = "org-card";
      topo.innerHTML = `<div class="label-muted">EQUIPE</div><div>Staffs GIL</div>`;
      root.appendChild(topo);

      root.appendChild(connectorV(36));
      root.appendChild(rail());

      // Pessoas numa √öNICA linha (nowrap)
      const row = document.createElement("div");
      row.className = "people-row";

      data.pessoas.forEach((nome, idxPessoa) => {
        const col = document.createElement("div");
        col.className = "person-col";

        const aberto = !(colapso[idxPessoa]); // default expandido

        const pessoaCard = document.createElement("div");
        pessoaCard.className = "org-card org-person";
        pessoaCard.innerHTML = `
          <div class="label-muted">PESSOA</div>
          <div class="editable" contenteditable="${editMode}"
               oninput="updateNome(${idxPessoa}, this.innerText)">${nome}</div>
          ${editMode ? `<span class="xbtn" title="Remover" onclick="event.stopPropagation(); removerPessoa(${idxPessoa})">‚ùå</span>` : ""}
          <span class="chev">${aberto ? "‚ñæ" : "‚ñ∏"}</span>
        `;
        pessoaCard.addEventListener("click", () => {
          colapso[idxPessoa] = !colapso[idxPessoa];
          persistCollapse();
          renderChart();
        });

        col.appendChild(pessoaCard);

        // Conector pessoa->pilares
        col.appendChild(connectorV(24));

        // Pilha de pilares (colaps√°vel)
        const pilhaWrap = document.createElement("div");
        pilhaWrap.className = "collapse";

        const pilha = document.createElement("div");
        pilha.className = "stack";

        // >>> SEMPRE MOSTRA TODOS OS PILARES <<<
        data.pilares.forEach((pilarNome, i) => {
          const atividade = (data.atividades[i] || [])[idxPessoa] ?? "";
          const bloco = document.createElement("div");
          bloco.className = "org-subcard";
          bloco.innerHTML = `
            <div class="label-muted">PILAR</div>
            <div class="editable" contenteditable="${editMode}"
                 oninput="updatePilar(${i}, this.innerText)">${pilarNome}</div>
            ${editMode ? `<span class="xbtn" title="Remover Pilar" onclick="removerPilar(${i})">üóëÔ∏è</span>` : ""}
            <div class="org-activity editable" contenteditable="${editMode}"
                 oninput="updateAtividade(${i}, ${idxPessoa}, this.innerText)">${atividade}</div>
            ${editMode ? `<div style="margin-top:6px;"><button onclick="limparAtividade(${i}, ${idxPessoa})">Limpar</button></div>` : ""}
          `;

          const holder = document.createElement("div");
          holder.style.display = "flex";
          holder.style.flexDirection = "column";
          holder.style.alignItems = "center";
          holder.appendChild(connectorV(16));
          holder.appendChild(bloco);

          pilha.appendChild(holder);
        });

        pilhaWrap.appendChild(pilha);
        col.appendChild(pilhaWrap);

        // Altura colaps√°vel
        requestAnimationFrame(()=>{
          if (colapso[idxPessoa]) {
            pilhaWrap.style.maxHeight = "0px";
          } else {
            pilhaWrap.style.maxHeight = pilha.scrollHeight + "px";
          }
        });

        row.appendChild(col);
      });

      root.appendChild(row);
      fitbox.appendChild(root);
      outer.appendChild(fitbox);
      wrapper.appendChild(outer);

      // aplica scale-to-fit centralizado (sem corte)
      requestAnimationFrame(fitToWidth);
    }

    // ---- Fun√ß√µes auxiliares de UI ----
    function rail(){ const r=document.createElement("div"); r.className="rail"; return r; }
    function connectorV(h){
      const v = document.createElement("div");
      v.className = "connector-v";
      if (h) v.style.height = h + "px";
      return v;
    }

    // Ajusta a escala para que TODAS as pessoas caibam em uma √∫nica linha,
    // mantendo o conte√∫do centralizado e sem cortes.
    function fitToWidth(){
      const wrapper = document.getElementById("organograma");
      const fitbox = document.getElementById("fitbox");
      const outer  = document.getElementById("fitouter");
      if(!wrapper || !fitbox || !outer) return;

      // reseta para medir largura "natural"
      fitbox.style.transform = "scale(1)";
      const naturalW = fitbox.scrollWidth;
      const wrapperW = wrapper.clientWidth;

      // margem de seguran√ßa 24px
      const scale = Math.min(1, (wrapperW - 24) / naturalW);

      // Aplica escala
      fitbox.style.transform = `scale(${scale})`;

      // Define largura visual do cont√™iner externo para centralizar corretamente
      const visualW = Math.max(0, Math.floor(naturalW * scale));
      outer.style.width = visualW + "px";
    }

    // ------- Atualiza√ß√µes de estado -------
    function toggleEditMode() {
      editMode = !editMode;
      const btn = document.getElementById("edit-mode-btn");
      btn.textContent = editMode ? "Concluir edi√ß√£o" : "Editar";
      renderChart();
      if (!editMode) salvar();
    }

    function updateNome(index, valor){ data.pessoas[index] = (valor || "").trim(); }
    function updatePilar(index, valor){ data.pilares[index] = (valor || "").trim(); }
    function updateAtividade(i, j, valor){
      if (!data.atividades[i]) data.atividades[i] = [];
      data.atividades[i][j] = valor || "";
    }

    function addPessoa(){
      const nome = prompt("Nome da nova pessoa:");
      if (!nome) return;
      data.pessoas.push(nome);
      data.atividades.forEach(r => r.push(""));
      colapso[data.pessoas.length - 1] = false;
      persistCollapse();
      renderChart();
    }

    function addPilar(){
      const nome = prompt("Nome do novo pilar:");
      if (!nome) return;
      data.pilares.push(nome);
      const nova = data.pessoas.map(()=>"");
      data.atividades.push(nova);
      renderChart();
    }

    function removerPessoa(index){
      if (!confirm("Remover esta pessoa e suas atividades?")) return;
      data.pessoas.splice(index,1);
      data.atividades.forEach(r=>r.splice(index,1));
      // Reindexa colapso
      const novo = {};
      data.pessoas.forEach((_, idx)=> novo[idx] = colapso[idx] || false);
      colapso = novo; persistCollapse();
      renderChart();
    }

    function removerPilar(index){
      if (!confirm("Remover este pilar (todas as atividades nas pessoas)?")) return;
      data.pilares.splice(index,1);
      data.atividades.splice(index,1);
      renderChart();
    }

    function limparAtividade(i,j){
      if (!data.atividades[i]) return;
      data.atividades[i][j] = "";
      renderChart();
    }

    function salvar(){
      localStorage.setItem("organograma", JSON.stringify(data));
      alert("Salvo com sucesso!");
    }

    // ---- DARK MODE + menu ----
    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("dark-mode") === "1") {
        document.body.classList.add("dark-mode");
      }
      const toggleButton = document.getElementById("toggle-mode");
      if (toggleButton) {
        toggleButton.addEventListener("click", () => {
          document.body.classList.toggle("dark-mode");
          localStorage.setItem("dark-mode", document.body.classList.contains("dark-mode") ? "1" : "");
        });
      }
      renderChart();
      window.addEventListener("resize", fitToWidth);
    });

    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    menuToggle.addEventListener('click', function () {
      sidebar.classList.toggle('active');
    });
    document.addEventListener('click', function (e) {
      if (window.innerWidth <= 768 && sidebar.classList.contains('active') &&
          !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
        sidebar.classList.remove('active');
      }
    });
  </script>

  <footer class="footer">
    <div class="footer-content" style="display:flex; justify-content:space-between; align-items:center;">
      <div class="footer-logo-group">
        <img src="assets/syncnex-logo-64x64.png" alt="Logo SyncNex" class="footer-logo" />
        <div>
          <span class="footer-title">SyncNex &copy; 2025</span>
          <span class="footer-slogan">Conectando efici√™ncia ao seu neg√≥cio</span>
        </div>
      </div>
      <nav class="footer-nav">
        <a href="#">Sobre N√≥s</a>
        <a href="#">Contato</a>
        <a href="#">Pol√≠tica de Privacidade</a>
        <a href="#">Termos de Uso</a>
      </nav>
      <span class="versao">Vers√£o <b>V1.0.0</b></span>
    </div>
  </footer>
</body>
</html>
