<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SyncNex - CSN</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="assets/syncnex-favicon.png">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Roboto, Arial, sans-serif;
      background: #f2f3f7;
      overflow: hidden;
    }
    #map {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      z-index: 0;
    }
    .custom-controls {
      position: fixed;
      top: 56px;
      left: 220px;
      z-index: 10;
      display: flex;
      gap: 12px;
    }
    .custom-controls button {
      padding: 9px 18px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 6px #0001;
      transition: background .2s;
    }
    .custom-controls button.active,
    .custom-controls button:hover {
      background: #e8e8e8;
    }
    .color-picker-bar {
      position: fixed;
      left: 220px;
      top: 10px;
      z-index: 15;
      display: flex;
      gap: 8px;
      padding: 6px 10px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px #0002;
      align-items: center;
      border: 1px solid #e6e6e6;
    }
    .color-circle {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px solid #8882;
      cursor: pointer;
      box-sizing: border-box;
      transition: border .18s;
    }
    .color-circle.selected {
      border: 3px solid #0bc77e;
    }
    .timer-bar {
      position: fixed;
      left: 230px; top: 0;
      font-size: 14px;
      color: #444;
      z-index: 10;
      background: #fafafadb;
      padding: 2px 16px 2px 8px;
      border-radius: 0 0 8px 8px;
      border-bottom: 1px solid #ddd;
    }
    .container {
      position: relative;
      z-index: 20;
      display: flex;
    }
    .sidebar {
      width: 200px;
      background: #161b22;
      color: #fff;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 30;
      display: flex;
      flex-direction: column;
      padding: 18px 0 0 0;
      box-shadow: 2px 0 16px #0002;
    }
    .sidebar .logo-csn {
      width: 155px;
      display: block;
      margin: 0 auto 24px auto;
    }
    .sidebar .menu {
      list-style: none;
      padding: 0 0 0 16px;
      margin: 0;
    }
    .sidebar .menu li {
      margin-bottom: 12px;
    }
    .sidebar .menu a {
      color: #ddd;
      text-decoration: none;
      font-weight: 500;
      font-size: 16px;
      transition: color .15s;
    }
    .sidebar .menu a:hover,
    .sidebar .menu__item a {
      color: #19f99c;
      font-weight: bold;
    }
    .main-content {
      margin-left: 220px;
      flex: 1;
      padding: 0;
    }
    /* Lixeira bot√£o na √°rea */
    .delete-area-btn {
      position: absolute;
      background: #fff;
      border: none;
      color: #c00;
      font-size: 22px;
      padding: 2px 7px;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 2px 8px #0003;
      z-index: 9999;
      transition: background .15s;
    }
    .delete-area-btn:hover {
      background: #fee;
    }
    .area-label {
      background: #fff;
      color: #222;
      border-radius: 8px;
      font-weight: bold;
      font-size: 13px;
      padding: 4px 12px;
      border: 1.5px solid #4bffb7;
      box-shadow: 0 2px 8px #0002;
      margin-top: 8px;
      pointer-events: none;
      white-space: pre-line;
    }
    .footer {
      position: fixed; left: 0; bottom: 0; width: 100vw;
      z-index: 99;
      background: rgba(10,16,30,0.94);
      box-shadow: 0 -4px 24px #0003;
      color: #fff;
    }
    #toggle-mode,
    .menu-toggle {
      position: fixed;
      top: 20px;
      z-index: 40;
      background: #222;
      color: #fff;
      border: none;
      font-size: 1.3rem;
      border-radius: 50%;
      width: 36px; height: 36px;
      box-shadow: 0 2px 12px #0003;
      cursor: pointer;
      transition: background .2s;
    }
    #toggle-mode { right: 20px;}
    .menu-toggle { left: 20px;}
    @media (min-width: 900px) {
      .menu-toggle { display: none;}
    }
    @media (max-width: 900px) {
      .sidebar { width: 85vw; min-width: 0;}
      .main-content { margin-left: 0; }
      .custom-controls, .timer-bar, .color-picker-bar { left: 90vw !important; }
    }
    body::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
  <button id="toggle-mode" class="darkmode-btn" title="Alternar modo escuro">üåì</button>
  <button class="menu-toggle" id="menu-toggle" aria-label="Abrir menu">&#9776;</button>
  <div class="container">
    <aside class="sidebar" id="sidebar">
      <a href="index.html">
        <img src="/assets/logo-csn.png" alt="Logo CSN" class="logo-csn" />
      </a>
      <ul class="menu">
        <li><a href="absenteismo.html">Absenteismo</a></li>
        <li><a href="contratos.html">Contratos</a></li>
        <li><a href="dgfm.html">DGFM</a></li>
        <li><a href="diesel.html">Diesel</a></li>
        <li><a href="efetivo.html">Efetivo</a></li>
        <li><a href="horaextra.html">Horas Extras</a></li>
        <li><a href="kanban.html">Kanban</a></li>
        <li><a href="mttr.html">MTTR</a></li>
        <li><a href="mtbf.html">MTBF</a></li>
        <li class="menu__item"><a href="organograma.html">Organograma</a></li>
        <li><a href="projetos.html">Projetos</a></li>
        <li><a href="sobressalentes.html">Sobressalentes</a></li>
      </ul>
    </aside>
    <main class="main-content"></main>
  </div>

  <div class="color-picker-bar" id="colorPickerBar">
    <span style="font-weight:600;font-size:15px">Cor da √°rea:</span>
    <div class="color-circle selected" style="background:#2196f3" data-color="#2196f3"></div>
    <div class="color-circle" style="background:#43a047" data-color="#43a047"></div>
    <div class="color-circle" style="background:#fbc02d" data-color="#fbc02d"></div>
    <div class="color-circle" style="background:#c62828" data-color="#c62828"></div>
    <div class="color-circle" style="background:#9c27b0" data-color="#9c27b0"></div>
    <div class="color-circle" style="background:#ff9800" data-color="#ff9800"></div>
    <input type="color" id="customColor" style="margin-left:10px;width:30px;height:28px;border:none;outline:none;cursor:pointer;background:#fff;" title="Mais cores" value="#2196f3"/>
  </div>
  <div class="timer-bar" id="timerBar">Pr√≥xima atualiza√ß√£o em: <span id="timerValue">01:00</span></div>
  <div class="custom-controls">
    <button id="mapBtn" class="active">Mapa</button>
    <button id="satBtn">Sat√©lite</button>
    <button id="drawAreaBtn">Desenhar √Årea</button>
    <button id="clearBtn">Limpar √Åreas</button>
  </div>
  <div id="map"></div>

  <script>
    // Timer countdown
    let seconds = 60;
    function updateTimer() {
      document.getElementById('timerValue').textContent = seconds < 10 ? `00:0${seconds}` : `00:${seconds}`;
      if (seconds > 0) {
        seconds--;
        setTimeout(updateTimer, 1000);
      } else {
        seconds = 60;
        setTimeout(updateTimer, 1000);
      }
    }
    updateTimer();
  </script>
  <script>
    // Cores para desenhar √°reas
    let selectedColor = "#2196f3";
    const colorCircles = document.querySelectorAll('.color-circle');
    colorCircles.forEach(c => {
      c.onclick = function() {
        colorCircles.forEach(el=>el.classList.remove('selected'));
        this.classList.add('selected');
        selectedColor = this.dataset.color;
        document.getElementById('customColor').value = rgb2hex(selectedColor);
      }
    });
    document.getElementById('customColor').oninput = function() {
      selectedColor = this.value;
      colorCircles.forEach(el=>el.classList.remove('selected'));
      // Marca o c√≠rculo custom como "selected" (adiciona visual ao color picker)
      this.style.border = "2px solid #0bc77e";
    };
    function rgb2hex(color) {
      if(color[0]==="#") return color;
      // de rgb(33,150,243) para #2196f3
      let m = color.match(/rgb\((\d+),(\d+),(\d+)\)/);
      if(!m) return color;
      return "#" + ((1<<24) + (+m[1]<<16) + (+m[2]<<8) + (+m[3])).toString(16).slice(1);
    }
  </script>
  <script>
    let map, drawingManager, drawnAreas = [];

    // Fun√ß√£o de ponto dentro de pol√≠gono (Ray-casting algorithm)
    function pointInPolygon(point, vs) {
      let x = point.lng, y = point.lat;
      let inside = false;
      for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
        let xi = vs[i].lng, yi = vs[i].lat;
        let xj = vs[j].lng, yj = vs[j].lat;
        let intersect = ((yi > y) !== (yj > y)) &&
          (x < (xj - xi) * (y - yi) / (yj - yi + 0.000001) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    // Fun√ß√£o de pol√≠gono dentro de pol√≠gono (todos os pontos do menor dentro do maior)
    function polygonInsidePolygon(small, large) {
      return small.every(pt => pointInPolygon(pt, large));
    }

    function createDeleteBtn(polygon, map, areaData) {
      // Coloca lixeira no "primeiro" v√©rtice (aproximado ao centro)
      const bounds = new google.maps.LatLngBounds();
      polygon.getPath().forEach(p => bounds.extend(p));
      const center = bounds.getCenter();
      const btn = document.createElement('button');
      btn.innerHTML = 'üóë';
      btn.className = 'delete-area-btn';
      btn.title = "Excluir √°rea";
      btn.style.left = '0px';
      btn.style.top = '0px';
      btn.onclick = function(e) {
        polygon.setMap(null);
        btn.remove();
        if(areaData.label) areaData.label.setMap(null);
        drawnAreas = drawnAreas.filter(d => d.polygon !== polygon);
      };
      document.body.appendChild(btn);

      // Fun√ß√£o para posicionar a lixeira
      function updateBtnPos() {
        const projection = map.getProjection();
        if(!projection) return;
        const point = map.getProjection().fromLatLngToPoint(center);
        const pos = map.getProjection().fromLatLngToContainerPixel(center);
        let p = map.getProjection().fromLatLngToDivPixel(center) || pos || {x:0,y:0};
        let scale = Math.pow(2, map.getZoom());
        // Projeta para pixel relativo √† tela
        const proj = map.getProjection();
        const bounds = map.getBounds();
        if(!bounds) return;
        const ne = bounds.getNorthEast();
        const sw = bounds.getSouthWest();
        const worldPoint = proj.fromLatLngToPoint(center);
        const topRight = proj.fromLatLngToPoint(ne);
        const bottomLeft = proj.fromLatLngToPoint(sw);
        const x = (worldPoint.x - bottomLeft.x) * scale;
        const y = (worldPoint.y - topRight.y) * scale;
        btn.style.left = (x + 220 - 16) + 'px'; // 220 = sidebar
        btn.style.top = (y + 66 - 28) + 'px';   // 66 = topo + color bar
      }
      google.maps.event.addListener(map, 'bounds_changed', updateBtnPos);
      google.maps.event.addListener(map, 'zoom_changed', updateBtnPos);
      updateBtnPos();
      return btn;
    }

    function createAreaLabel(map, center, name, parentName) {
      return new google.maps.InfoWindow({
        content: `<div class="area-label">${name}${parentName?'<br><span style="font-size:11px;font-weight:400;color:#777">Filha de: '+parentName+'</span>':''}</div>`,
        position: center,
        pixelOffset: new google.maps.Size(0, -18),
      });
    }

    function getPolygonPathLatLngArr(polygon) {
      return polygon.getPath().getArray().map(latlng => ({lat: latlng.lat(), lng: latlng.lng()}));
    }

    function findParentArea(coords) {
      // Procura pol√≠gono que contenha todos os pontos deste
      for(let area of drawnAreas) {
        const parentCoords = getPolygonPathLatLngArr(area.polygon);
        if(polygonInsidePolygon(coords, parentCoords)) return area;
      }
      return null;
    }

    function getPolygonCenter(polygon) {
      const path = polygon.getPath().getArray();
      let lat=0, lng=0;
      for(let p of path) { lat += p.lat(); lng += p.lng(); }
      return {lat:lat/path.length, lng:lng/path.length};
    }

    function openLabel(area) {
      if(area.label) area.label.open(map);
    }

    function closeLabel(area) {
      if(area.label) area.label.close();
    }

    function closeAllLabels() {
      drawnAreas.forEach(a => closeLabel(a));
    }

    function saveArea(area) {
      // Aqui voc√™ pode integrar com backend ou localStorage
    }

    function promptForAreaName() {
      let name = prompt("Digite o nome para a nova √°rea:");
      if (!name) name = "√Årea sem nome";
      return name;
    }

    function handlePolygonComplete(polygon) {
      let color = polygon.fillColor || selectedColor;
      let coords = getPolygonPathLatLngArr(polygon);
      let name = promptForAreaName();
      let parentArea = findParentArea(coords);

      // Verifica se pol√≠gono est√° dentro de algum outro (parent)
      let parentName = '';
      if(parentArea) {
        if(confirm(`Esta √°rea est√° dentro da √°rea "${parentArea.name}". Deseja vincular como filha?`)) {
          parentName = parentArea.name;
        }
      }

      // Cria label
      let center = getPolygonCenter(polygon);
      let label = createAreaLabel(map, center, name, parentName);
      label.open(map);

      // Bot√£o de excluir
      let btn = createDeleteBtn(polygon, map, {label});

      // Salva √°rea na lista
      let areaObj = {polygon, name, color, parentName, label, btn};
      drawnAreas.push(areaObj);

      // Evento ao clicar na √°rea, mostra label
      google.maps.event.addListener(polygon, 'click', function(event){
        closeAllLabels();
        label.open(map);
      });

      // Atualiza label ao editar a √°rea
      google.maps.event.addListener(polygon.getPath(), 'set_at', function(){
        let c = getPolygonCenter(polygon);
        label.setPosition(c);
      });
      google.maps.event.addListener(polygon.getPath(), 'insert_at', function(){
        let c = getPolygonCenter(polygon);
        label.setPosition(c);
      });

      // Evento ao mover √°rea, atualiza bot√£o
      google.maps.event.addListener(polygon, 'dragend', function(){
        btn && btn.remove();
        btn = createDeleteBtn(polygon, map, {label});
      });

      saveArea(areaObj);
    }

    function setPolygonColor(color) {
      if(drawingManager)
        drawingManager.setOptions({
          polygonOptions: {
            editable: true,
            draggable: true,
            strokeColor: color,
            fillColor: color,
            fillOpacity: 0.18,
            strokeWeight: 2,
          }
        });
    }

    function clearAllAreas() {
      drawnAreas.forEach(({polygon, label, btn}) => {
        if(label) label.close();
        polygon.setMap(null);
        btn && btn.remove();
      });
      drawnAreas = [];
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: -22.5162, lng: -44.0948},
        zoom: 15,
        mapTypeId: 'roadmap',
        streetViewControl: true,
        fullscreenControl: true,
      });

      drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: null,
        drawingControl: false,
        polygonOptions: {
          editable: true,
          draggable: true,
          strokeColor: selectedColor,
          fillColor: selectedColor,
          fillOpacity: 0.18,
          strokeWeight: 2,
        }
      });

      drawingManager.setMap(map);

      // Alterar cor antes de desenhar
      document.querySelectorAll('.color-circle, #customColor').forEach(el => {
        el.addEventListener('click', function(){
          setPolygonColor(selectedColor);
        });
        el.addEventListener('input', function(){
          setPolygonColor(selectedColor);
        });
      });

      // Ao desenhar
      google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon) {
        // Aplica cor da sele√ß√£o
        polygon.setOptions({
          fillColor: selectedColor,
          strokeColor: selectedColor
        });
        handlePolygonComplete(polygon);
        drawingManager.setDrawingMode(null);
        document.getElementById('drawAreaBtn').classList.remove('active');
      });

      document.getElementById('drawAreaBtn').onclick = function() {
        setPolygonColor(selectedColor);
        drawingManager.setDrawingMode('polygon');
        this.classList.add('active');
      };
      document.getElementById('clearBtn').onclick = function() {
        clearAllAreas();
      };
      document.getElementById('mapBtn').onclick = function() {
        map.setMapTypeId('roadmap');
        this.classList.add('active');
        document.getElementById('satBtn').classList.remove('active');
      };
      document.getElementById('satBtn').onclick = function() {
        map.setMapTypeId('satellite');
        this.classList.add('active');
        document.getElementById('mapBtn').classList.remove('active');
      };
    }
  </script>
  <!-- Troque por sua key: -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=drawing&callback=initMap" async defer></script>
  <script>
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    menuToggle.addEventListener('click', function () {
      sidebar.classList.toggle('active');
    });
    document.addEventListener('click', function (e) {
      if (
        window.innerWidth <= 900 &&
        sidebar.classList.contains('active') &&
        !sidebar.contains(e.target) &&
        !menuToggle.contains(e.target)
      ) {
        sidebar.classList.remove('active');
      }
    });
  </script>
  <script src="darkmode.js"></script>
</body>
<footer class="footer">
  <div class="footer-content" style="display: flex; justify-content: space-between; align-items: center;">
    <div class="footer-logo-group">
      <img src="assets/syncnex-logo-64x64.png" alt="Logo SyncNex" class="footer-logo" />
      <div>
        <span class="footer-title">SyncNex &copy; 2025</span>
        <span class="footer-slogan">Conectando efici√™ncia ao seu neg√≥cio</span>
      </div>
    </div>
    <nav class="footer-nav">
      <a href="#">Sobre N√≥s</a>
      <a href="#">Contato</a>
      <a href="#">Pol√≠tica de Privacidade</a>
      <a href="#">Termos de Uso</a>
    </nav>
      <span class="versao">Vers√£o <b>V1.0.0</b></span>
    </div>
  </div>
</footer>
</html>
