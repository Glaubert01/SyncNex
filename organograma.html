<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SyncNex - CSN</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="assets/syncnex-favicon.png">
  <style>
    :root{
      --line:#2a5f8a;
      --line-dark:#7fb3ff;
      --card-fg:#0b3a5b;
      --card-bg:#e7f2fb;
      --subcard-bg:#ffffff;
      --subcard-fg:#2b2b2b;
      --activity-bg:#f6f7fb;
    }

    /* ===== √Årea do organograma + scale-to-fit ===== */
    .org-wrapper{
      padding:12px;
      overflow-x:hidden;      /* nunca mostra rolagem horizontal */
      max-width:100%;
    }
    .fitouter{ margin:0 auto; width:max-content; }
    .fitbox{
      transform-origin: top left;
      display:block;
      width:max-content;      /* largura natural para medi√ß√£o */
    }

    .org-root{display:flex;flex-direction:column;align-items:center;gap:22px}

    .org-card{
      min-width:160px; max-width:240px; text-align:center;
      background:var(--card-bg); color:var(--card-fg);
      border-radius:14px; padding:12px; font-weight:700;
      box-shadow:0 1px 0 rgba(0,0,0,.08), 0 6px 14px rgba(0,0,0,.06);
      position:relative;
    }
    .org-person{cursor:pointer; user-select:none; position:relative;}
    .org-person .chev{font-weight:900; opacity:.9; margin-left:6px}

    .org-subcard{
      background:var(--subcard-bg); color:var(--subcard-fg);
      border-radius:12px; padding:10px 12px; font-weight:600;
      box-shadow:0 1px 0 rgba(0,0,0,.06);
      width:260px; max-width:92vw;
      position:relative;
    }
    .org-activity{
      font-weight:500; margin-top:8px; padding:8px 10px; border-radius:10px;
      background:var(--activity-bg)
    }

    .editable[contenteditable="true"]{outline:2px dashed #88a; border-radius:6px; padding:2px 4px}
    .xbtn{margin-left:6px; cursor:pointer}

    /* Conectores refor√ßados */
    .connector-v{
      width:6px; background:var(--line); height:28px; margin:2px auto; border-radius:3px;
      box-shadow:0 0 0 1px rgba(0,0,0,.03);
    }
    .stack{display:flex; flex-direction:column; align-items:center; gap:16px; margin-top:8px}
    .stack .connector-v{height:18px}

    /* Linha horizontal (decorativa) */
    .rail{ width:100%; height:6px; background:var(--line); border-radius:4px; opacity:.45; }

    /* Pessoas sempre em uma √∫nica linha */
    .people-row{
      display:flex; flex-wrap:nowrap; gap:32px; justify-content:center; align-items:flex-start;
      width:max-content;
    }
    .person-col{display:flex; flex-direction:column; align-items:center; padding:0 4px}

    .label-muted{font-size:11px; font-weight:600; opacity:.9; letter-spacing:.04em}

    /* Colaps√°vel */
    .collapse{ overflow:hidden; transition:max-height .28s ease; width:100%; display:block; }

    /* Seletor de cor (aparece no modo edi√ß√£o) */
    .colorpick{
      position:absolute; top:6px; right:8px; width:22px; height:22px;
      border:none; background:transparent; padding:0; cursor:pointer;
    }
    .colorpick::-webkit-color-swatch{border-radius:6px; border:1px solid rgba(0,0,0,.2)}
    .colorpick::-moz-color-swatch{border-radius:6px; border:1px solid rgba(0,0,0,.2)}

    /* ===== Dark mode ===== */
    body.dark-mode{
      --card-bg:#124c74;
      --card-fg:#e6f0f7;
      --subcard-bg:#1e2b36;
      --subcard-fg:#e6f0f7;
      --activity-bg:#16222c;
    }
    body.dark-mode .connector-v, body.dark-mode .rail{background:var(--line-dark)}
  </style>
</head>
<body>
  <button id="toggle-mode" class="darkmode-btn" title="Alternar modo escuro">üåì</button>
  <button class="menu-toggle" id="menu-toggle" aria-label="Abrir menu">&#9776;</button>

  <div class="container">
    <aside class="sidebar" id="sidebar">
      <a href="index.html">
        <img src="assets/logo-csn.png" alt="Logo CSN" class="logo-csn" />
      </a>
      <ul class="menu">
        <li><a href="absenteismo.html">Absenteismo</a></li>
        <li><a href="contratos.html">Contratos</a></li>
        <li><a href="dgfm.html">DGFM</a></li>
        <li><a href="diesel.html">Diesel</a></li>
        <li><a href="efetivo.html">Efetivo</a></li>
        <li><a href="horaextra.html">Horas Extras</a></li>
        <li><a href="kanban.html">Kanban</a></li>
        <li><a href="mapa.html">Mapa</a></li>
        <li class="menu__item"><a href="milk.html">Milk Run</a></li>
        <li><a href="mttr.html">MTTR</a></li>
        <li><a href="mtbf.html">MTBF</a></li>
        <li class="menu__item"><a href="organograma.html">Organograma</a></li>
        <li><a href="projetos.html">Projetos</a></li>
        <li><a href="sobressalentes.html">Sobressalentes</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <h2 class="titulo">Organograma de Atividades Staffs GIL</h2>

      <div id="organograma" class="org-wrapper">
        <!-- JS injeta .fitouter > .fitbox aqui -->
      </div>

      <div class="controls">
        <button id="edit-mode-btn" onclick="toggleEditMode()">Editar</button>
        <button onclick="addPessoa()">Adicionar Pessoa</button>
        <button onclick="addPilar()">Adicionar Pilar</button>
        <button onclick="salvar()">Salvar</button>
      </div>
    </main>
  </div>

  <script>
    let editMode = false;

    // ===== Estado principal (dados) =====
    let data = JSON.parse(localStorage.getItem("organograma")) || {
      pessoas: ["Glaubert", "Sergio", "Daiana"],
      pilares: ["Pilar A", "Pilar B", "Pilar C"],
      atividades: [
        ["Atividade A1", "Atividade A2", "Atividade A3"],
        ["Atividade B1", "Atividade B2", "Atividade B3"],
        ["Atividade C1", "Atividade C2", "Atividade C3"]
      ]
    };

    // ===== Cores por caixa =====
    // team: cor do cart√£o "Equipe"
    // pessoas[j]: cor do cart√£o da pessoa j
    // subcards[i][j]: cor do cart√£o Pilar(i) x Pessoa(j)
    let colors = JSON.parse(localStorage.getItem("org-colors")) || {
      team: null,
      pessoas: [],
      subcards: []
    };

    // ===== Estado de colapso por pessoa =====
    let colapso = JSON.parse(localStorage.getItem("org-colapso")) || {};

    function persistCollapse(){ localStorage.setItem("org-colapso", JSON.stringify(colapso)); }
    function persistColors(){ localStorage.setItem("org-colors", JSON.stringify(colors)); }

    // Garante que 'colors' tenha o mesmo formato/tamanho de 'data'
    function normalizeColors(){
      if (!colors.pessoas) colors.pessoas = [];
      if (!colors.subcards) colors.subcards = [];

      // ajusta pessoas
      while (colors.pessoas.length < data.pessoas.length) colors.pessoas.push(null);
      if (colors.pessoas.length > data.pessoas.length) colors.pessoas.length = data.pessoas.length;

      // ajusta linhas de subcards (pilares)
      while (colors.subcards.length < data.pilares.length) {
        colors.subcards.push(Array(data.pessoas.length).fill(null));
      }
      if (colors.subcards.length > data.pilares.length) colors.subcards.length = data.pilares.length;

      // ajusta colunas de subcards (pessoas)
      colors.subcards.forEach((row, i) => {
        while (row.length < data.pessoas.length) row.push(null);
        if (row.length > data.pessoas.length) row.length = data.pessoas.length;
      });
      persistColors();
    }
    normalizeColors();

    // ===== Helpers de cor =====
    function isDark(hex){
      if (!hex) return false;
      const c = hex.replace('#','');
      const bigint = parseInt(c.length===3 ? c.split('').map(x=>x+x).join('') : c, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      // lumin√¢ncia relativa
      const l = 0.2126*(r/255)**2.2 + 0.7152*(g/255)**2.2 + 0.0722*(b/255)**2.2;
      return l < 0.45;
    }
    function applyCardColor(el, hex){
      if (!el) return;
      if (hex){
        el.style.background = hex;
        el.style.color = isDark(hex) ? '#f9fbff' : '#0b2233';
      }else{
        el.style.background = '';
        el.style.color = '';
      }
    }

    // ===== Render =====
    function renderChart() {
      const wrapper = document.getElementById("organograma");
      wrapper.innerHTML = "";

      const outer = document.createElement("div");
      outer.id = "fitouter";
      outer.className = "fitouter";

      const fitbox = document.createElement("div");
      fitbox.id = "fitbox";
      fitbox.className = "fitbox";

      const root = document.createElement("div");
      root.className = "org-root";

      // Cart√£o topo (Equipe)
      const topo = document.createElement("div");
      topo.className = "org-card";
      topo.innerHTML = `
        <div class="label-muted">EQUIPE</div>
        <div>Staffs GIL</div>
        ${editMode ? `<input type="color" class="colorpick" value="${colors.team || '#e7f2fb'}"
                   onchange="updateColor('team', null, null, this.value)">` : ""}
      `;
      applyCardColor(topo, colors.team);
      root.appendChild(topo);

      root.appendChild(connectorV(36));
      root.appendChild(rail());

      // Pessoas em linha √∫nica
      const row = document.createElement("div");
      row.className = "people-row";

      data.pessoas.forEach((nome, j) => {
        const col = document.createElement("div");
        col.className = "person-col";

        const aberto = !(colapso[j]); // default expandido

        const pessoaCard = document.createElement("div");
        pessoaCard.className = "org-card org-person";
        pessoaCard.innerHTML = `
          <div class="label-muted">PESSOA</div>
          <div class="editable" contenteditable="${editMode}"
               oninput="updateNome(${j}, this.innerText)">${nome}</div>
          ${editMode ? `<span class="xbtn" title="Remover" onclick="event.stopPropagation(); removerPessoa(${j})">‚ùå</span>` : ""}
          ${editMode ? `<input type="color" class="colorpick" value="${colors.pessoas[j] || '#e7f2fb'}"
                onclick="event.stopPropagation();" onchange="updateColor('pessoa', ${j}, null, this.value)">` : ""}
          <span class="chev">${aberto ? "‚ñæ" : "‚ñ∏"}</span>
        `;
        pessoaCard.addEventListener("click", () => {
          colapso[j] = !colapso[j];
          localStorage.setItem("org-colapso", JSON.stringify(colapso));
          renderChart();
        });
        applyCardColor(pessoaCard, colors.pessoas[j]);
        col.appendChild(pessoaCard);

        // Conector pessoa->pilares
        col.appendChild(connectorV(24));

        // Pilha de pilares (colaps√°vel)
        const pilhaWrap = document.createElement("div");
        pilhaWrap.className = "collapse";

        const pilha = document.createElement("div");
        pilha.className = "stack";

        // Sempre mostra TODOS os pilares
        data.pilares.forEach((pilarNome, i) => {
          const atividade = (data.atividades[i] || [])[j] ?? "";

          const bloco = document.createElement("div");
          bloco.className = "org-subcard";
          bloco.innerHTML = `
            <div class="label-muted">PILAR</div>
            <div class="editable" contenteditable="${editMode}"
                 oninput="updatePilar(${i}, this.innerText)">${pilarNome}</div>
            ${editMode ? `<span class="xbtn" title="Remover Pilar" onclick="removerPilar(${i})">üóëÔ∏è</span>` : ""}
            ${editMode ? `<input type="color" class="colorpick" value="${(colors.subcards[i] && colors.subcards[i][j]) || '#ffffff'}"
                 onchange="updateColor('subcard', ${i}, ${j}, this.value)">` : ""}
            <div class="org-activity editable" contenteditable="${editMode}"
                 oninput="updateAtividade(${i}, ${j}, this.innerText)">${atividade}</div>
            ${editMode ? `<div style="margin-top:6px;"><button onclick="limparAtividade(${i}, ${j})">Limpar</button></div>` : ""}
          `;
          applyCardColor(bloco, colors.subcards[i] && colors.subcards[i][j]);

          const holder = document.createElement("div");
          holder.style.display = "flex";
          holder.style.flexDirection = "column";
          holder.style.alignItems = "center";
          holder.appendChild(connectorV(16));
          holder.appendChild(bloco);

          pilha.appendChild(holder);
        });

        pilhaWrap.appendChild(pilha);
        col.appendChild(pilhaWrap);

        // Altura colaps√°vel
        requestAnimationFrame(()=>{
          if (colapso[j]) pilhaWrap.style.maxHeight = "0px";
          else            pilhaWrap.style.maxHeight = pilha.scrollHeight + "px";
        });

        row.appendChild(col);
      });

      root.appendChild(row);
      fitbox.appendChild(root);
      outer.appendChild(fitbox);
      wrapper.appendChild(outer);

      // aplica scale-to-fit centralizado (sem corte)
      requestAnimationFrame(fitToWidth);
    }

    // ---- UI helpers ----
    function rail(){ const r=document.createElement("div"); r.className="rail"; return r; }
    function connectorV(h){
      const v = document.createElement("div");
      v.className = "connector-v";
      if (h) v.style.height = h + "px";
      return v;
    }

    // Ajuste de escala para caber 100% em uma √∫nica linha
    function fitToWidth(){
      const wrapper = document.getElementById("organograma");
      const fitbox  = document.getElementById("fitbox");
      const outer   = document.getElementById("fitouter");
      if(!wrapper || !fitbox || !outer) return;

      fitbox.style.transform = "scale(1)";
      const naturalW = fitbox.scrollWidth;
      const wrapperW = wrapper.clientWidth;
      const scale = Math.min(1, (wrapperW - 24) / naturalW);

      fitbox.style.transform = `scale(${scale})`;
      outer.style.width = Math.max(0, Math.floor(naturalW * scale)) + "px";
    }

    // ===== Atualiza√ß√µes de estado =====
    function toggleEditMode() {
      editMode = !editMode;
      const btn = document.getElementById("edit-mode-btn");
      btn.textContent = editMode ? "Concluir edi√ß√£o" : "Editar";
      renderChart();
      if (!editMode) salvar();
    }

    function updateNome(index, valor){ data.pessoas[index] = (valor || "").trim(); }
    function updatePilar(index, valor){ data.pilares[index] = (valor || "").trim(); }
    function updateAtividade(i, j, valor){
      if (!data.atividades[i]) data.atividades[i] = [];
      data.atividades[i][j] = valor || "";
    }

    // Sele√ß√£o de cor
    function updateColor(tipo, a, b, hex){
      if (tipo === 'team'){
        colors.team = hex;
      } else if (tipo === 'pessoa'){
        colors.pessoas[a] = hex;
      } else if (tipo === 'subcard'){
        if (!colors.subcards[a]) colors.subcards[a] = [];
        colors.subcards[a][b] = hex;
      }
      persistColors();
      renderChart();
    }

    function addPessoa(){
      const nome = prompt("Nome da nova pessoa:");
      if (!nome) return;
      data.pessoas.push(nome);
      data.atividades.forEach(r => r.push(""));
      colapso[data.pessoas.length - 1] = false;

      // cores
      colors.pessoas.push(null);
      colors.subcards.forEach(row => row.push(null));

      persistCollapse(); normalizeColors(); renderChart();
    }

    function addPilar(){
      const nome = prompt("Nome do novo pilar:");
      if (!nome) return;
      data.pilares.push(nome);
      const nova = data.pessoas.map(()=>"");
      data.atividades.push(nova);

      // cores
      colors.subcards.push(Array(data.pessoas.length).fill(null));

      normalizeColors(); renderChart();
    }

    function removerPessoa(index){
      if (!confirm("Remover esta pessoa e suas atividades?")) return;
      data.pessoas.splice(index,1);
      data.atividades.forEach(r=>r.splice(index,1));

      // cores
      colors.pessoas.splice(index,1);
      colors.subcards.forEach(r=>r.splice(index,1));

      // reindexa colapso
      const novo = {};
      data.pessoas.forEach((_, idx)=> novo[idx] = colapso[idx] || false);
      colapso = novo; persistCollapse(); normalizeColors(); renderChart();
    }

    function removerPilar(index){
      if (!confirm("Remover este pilar (todas as atividades nas pessoas)?")) return;
      data.pilares.splice(index,1);
      data.atividades.splice(index,1);

      // cores
      colors.subcards.splice(index,1);

      normalizeColors(); renderChart();
    }

    function limparAtividade(i,j){
      if (!data.atividades[i]) return;
      data.atividades[i][j] = "";
      renderChart();
    }

    function salvar(){
      localStorage.setItem("organograma", JSON.stringify(data));
      alert("Salvo com sucesso!");
    }

    // ---- DARK MODE + menu ----
    document.addEventListener("DOMContentLoaded", () => {
      // Dark mode persistente
      if (localStorage.getItem("dark-mode") === "1") {
        document.body.classList.add("dark-mode");
      }
      const toggleButton = document.getElementById("toggle-mode");
      if (toggleButton) {
        toggleButton.addEventListener("click", () => {
          document.body.classList.toggle("dark-mode");
          localStorage.setItem("dark-mode", document.body.classList.contains("dark-mode") ? "1" : "");
        });
      }

      renderChart();
      window.addEventListener("resize", fitToWidth);
    });

    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    menuToggle.addEventListener('click', function () {
      sidebar.classList.toggle('active');
    });
    document.addEventListener('click', function (e) {
      if (window.innerWidth <= 768 && sidebar.classList.contains('active') &&
          !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
        sidebar.classList.remove('active');
      }
    });
  </script>

  <footer class="footer">
    <div class="footer-content" style="display:flex; justify-content:space-between; align-items:center;">
      <div class="footer-logo-group">
        <img src="assets/syncnex-logo-64x64.png" alt="Logo SyncNex" class="footer-logo" />
        <div>
          <span class="footer-title">SyncNex &copy; 2025</span>
          <span class="footer-slogan">Conectando efici√™ncia ao seu neg√≥cio</span>
        </div>
      </div>
      <nav class="footer-nav">
        <a href="#">Sobre N√≥s</a>
        <a href="#">Contato</a>
        <a href="#">Pol√≠tica de Privacidade</a>
        <a href="#">Termos de Uso</a>
      </nav>
      <span class="versao">Vers√£o <b>V1.0.0</b></span>
    </div>
  </footer>
</body>
</html>
