<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SyncNex - CSN</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="assets/syncnex-favicon.png">
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: Roboto, Arial, sans-serif;
    }
    #map {
      width: 100vw; height: 100vh;
      position: absolute; left: 0; top: 0; z-index: 1;
    }
    .custom-controls {
      position: absolute;
      top: 10px; left: 180px;
      z-index: 5;
      display: flex;
      gap: 8px;
      align-items: center;
      background: transparent;
    }
    .custom-controls button, .custom-controls input[type="color"] {
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 6px #0001;
      transition: background .2s;
      margin-right: 0;
      outline: none;
    }
    .custom-controls input[type="color"] {
      width: 28px; height: 28px;
      padding: 0; border: 2px solid #888;
      background: none;
      cursor: pointer;
      box-shadow: none;
    }
    .custom-controls button.active,
    .custom-controls button:hover {
      background: #e8e8e8;
    }
    .timer-bar {
      position: absolute;
      left: 190px; top: 0;
      font-size: 14px;
      color: #444;
      z-index: 10;
      background: #fafafadb;
      padding: 2px 16px 2px 8px;
      border-radius: 0 0 8px 8px;
      border-bottom: 1px solid #ddd;
    }
    /* Bal√£o customizado para nomear/excluir √°rea */
    .polygon-label-box {
      position: absolute;
      background: #fff;
      box-shadow: 0 4px 24px #0004;
      border-radius: 10px;
      padding: 12px 10px 10px 10px;
      text-align: center;
      min-width: 140px;
      min-height: 55px;
      z-index: 10;
      border: 1px solid #e5e5e5;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .polygon-label-box input[type="text"] {
      width: 80px;
      padding: 4px 6px;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #aaa;
      text-align: center;
      margin-bottom: 3px;
    }
    .polygon-label-box button {
      background: #fa3e3e;
      border: none;
      color: #fff;
      border-radius: 5px;
      padding: 2px 12px;
      cursor: pointer;
      margin: 0 2px;
      font-size: 15px;
    }
    .polygon-label-box button.close-btn {
      background: #e3e3e3; color: #333;
      font-size: 18px;
      padding: 0 8px;
      position: absolute;
      top: 2px; right: 8px;
    }
    .polygon-label-box .polygon-parent-info {
      font-size: 11px; color: #777; margin-top: 3px;
    }
    /* Sidebar sempre vis√≠vel */
    .container, .main-content, .table-container, .em-construcao {
      display: block !important;
    }
    #map {
      left: 0;
    }
    /* Coloca o mapa atr√°s do conte√∫do lateral */
    .container {
      position: relative;
      z-index: 10;
    }
    .sidebar {
      z-index: 11;
      background: #171a22f8;
    }
    .main-content {
      z-index: 12;
      position: relative;
    }
    .footer {
      position: fixed; left: 0; bottom: 0; width: 100vw;
      z-index: 99;
      background: rgba(10,16,30,0.94);
      box-shadow: 0 -4px 24px #0003;
      color: #fff;
    }
    @media (max-width: 900px) {
      .custom-controls, .timer-bar { left: 10px; }
    }
  </style>
</head>
<body>
  <button id="toggle-mode" class="darkmode-btn" title="Alternar modo escuro">üåì</button>
  <button class="menu-toggle" id="menu-toggle" aria-label="Abrir menu">&#9776;</button>
  <div class="container">
    <aside class="sidebar" id="sidebar">
      <a href="index.html">
        <img src="/assets/logo-csn.png" alt="Logo CSN" class="logo-csn" />
      </a>
      <ul class="menu">
        <li><a href="absenteismo.html">Absenteismo</a></li>
        <li><a href="contratos.html">Contratos</a></li>
        <li><a href="dgfm.html">DGFM</a></li>
        <li><a href="diesel.html">Diesel</a></li>
        <li><a href="efetivo.html">Efetivo</a></li>
        <li><a href="horaextra.html">Horas Extras</a></li>
        <li><a href="kanban.html">Kanban</a></li>
        <li><a href="mttr.html">MTTR</a></li>
        <li><a href="mtbf.html">MTBF</a></li>
        <li class="menu__item"><a href="organograma.html">Organograma</a></li>                           
        <li><a href="projetos.html">Projetos</a></li>
        <li><a href="sobressalentes.html">Sobressalentes</a></li>
      </ul>
    </aside>
    <main class="main-content">
      <h2 class="titulo">GIL - Ger√™ncia de Transporte Ferrovi√°rio</h2>
      <div class="table-container">
        <table id="organograma"></table>
      </div>
    </main>
  </div>
  <!-- CONTROLES DO MAPA E MAPA GOOGLE -->
  <div class="timer-bar" id="timerBar">Pr√≥xima atualiza√ß√£o em: <span id="timerValue">01:00</span></div>
  <div class="custom-controls">
    <button id="mapBtn" class="active">Mapa</button>
    <button id="satBtn">Sat√©lite</button>
    <input type="color" id="colorPicker" value="#4287f5" title="Cor da √Årea">
    <button id="drawAreaBtn">Desenhar √Årea</button>
    <button id="clearBtn">Limpar √Åreas</button>
    <label style="margin-left:10px;"><input type="checkbox" id="reliefToggle"> Relevo</label>
  </div>
  <div id="map"></div>
  <script>
    // Timer countdown
    let seconds = 60;
    function updateTimer() {
      document.getElementById('timerValue').textContent = seconds < 10 ? `00:0${seconds}` : `00:${seconds}`;
      if (seconds > 0) {
        seconds--;
        setTimeout(updateTimer, 1000);
      } else {
        seconds = 60;
        setTimeout(updateTimer, 1000);
      }
    }
    updateTimer();
  </script>
  <script>
    let map, drawingManager, drawnAreas = [];
    let overlays = [];
    let colorSelected = "#4287f5";
    let reliefLayer = null;
    let labelBoxes = [];
    // Helpers
    function areaCoordsToLatLngs(coords) {
      return coords.map(([lat, lng]) => new google.maps.LatLng(lat, lng));
    }
    function getPolygonBounds(polygon) {
      const bounds = new google.maps.LatLngBounds();
      polygon.getPath().forEach((p) => bounds.extend(p));
      return bounds;
    }
    function pointInPolygon(point, poly) {
      // Google Maps geometry lib is NOT loaded. Simple Ray Casting
      let x = point.lat(), y = point.lng();
      let inside = false;
      let path = poly.getPath().getArray();
      for (let i=0,j=path.length-1; i<path.length; j=i++) {
        let xi=path[i].lat(), yi=path[i].lng();
        let xj=path[j].lat(), yj=path[j].lng();
        let intersect = ((yi > y) !== (yj > y)) &&
          (x < (xj - xi) * (y - yi) / (yj - yi + 0.0000001) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }
    function getParentPolygonIdx(latlngs) {
      // Busca pol√≠gono maior que contenha todos os pontos deste
      for (let i=0; i<overlays.length; ++i) {
        let poly = overlays[i].polygon;
        if (poly.getPath().getArray().length <= latlngs.length) continue;
        let inside = latlngs.every(p => pointInPolygon(p, poly));
        if (inside) return i;
      }
      return null;
    }
    // Persist√™ncia
    function saveAreas() {
      localStorage.setItem("geo_areas", JSON.stringify(overlays.map(o=>{
        return {
          name: o.name,
          color: o.color,
          coords: o.polygon.getPath().getArray().map(ll=>[ll.lat(),ll.lng()]),
          parent: o.parent
        }
      })));
    }
    function loadAreas() {
      let areas = JSON.parse(localStorage.getItem("geo_areas")||"[]");
      areas.forEach(area=>{
        let polygon = new google.maps.Polygon({
          paths: areaCoordsToLatLngs(area.coords),
          strokeColor: area.color,
          fillColor: area.color,
          fillOpacity: 0.16,
          strokeWeight: 2,
          editable: false,
          draggable: false,
          map: map
        });
        let bounds = getPolygonBounds(polygon).getCenter();
        let infowindow = null;
        overlays.push({polygon, name: area.name, color: area.color, infowindow, parent: area.parent});
        attachPolygonEvents(polygon, overlays.length-1);
        addPolygonLabelBox(polygon, area.name, area.color, overlays.length-1, area.parent);
      });
    }
    // Cria bal√£o de nomea√ß√£o e exclus√£o
    function addPolygonLabelBox(polygon, name, color, idx, parentIdx) {
      let bounds = getPolygonBounds(polygon).getCenter();
      let div = document.createElement("div");
      div.className = "polygon-label-box";
      div.style.position = "absolute";
      div.style.display = "none";
      let close = document.createElement("button");
      close.className = "close-btn";
      close.innerHTML = "&times;";
      close.onclick = function(e){
        e.stopPropagation();
        div.style.display="none";
      };
      let input = document.createElement("input");
      input.type = "text";
      input.value = name||"";
      input.placeholder = "Nome da √°rea";
      input.onchange = function(){
        overlays[idx].name = input.value;
        saveAreas();
      }
      let delBtn = document.createElement("button");
      delBtn.textContent = "Excluir";
      delBtn.onclick = function(e){
        overlays[idx].polygon.setMap(null);
        div.remove();
        overlays.splice(idx,1);
        labelBoxes.splice(idx,1);
        saveAreas();
        updateLabelBoxes();
      };
      div.appendChild(close);
      div.appendChild(input);
      div.appendChild(delBtn);
      if(parentIdx!==null && overlays[parentIdx]) {
        let span = document.createElement("span");
        span.className = "polygon-parent-info";
        span.textContent = `Vinculada a: ${overlays[parentIdx].name||'(sem nome)'}`;
        div.appendChild(span);
      }
      document.body.appendChild(div);
      labelBoxes[idx]=div;
      // Mostra ao clicar no pol√≠gono
      polygon.addListener('click', function(e){
        hideAllLabelBoxes();
        let proj = map.getProjection();
        let pos = e.latLng || bounds;
        let point = map.getProjection().fromLatLngToPoint(pos);
        let scale = Math.pow(2, map.getZoom());
        let worldCoordinate = map.getProjection().fromLatLngToPoint(pos);
        let mapDiv = map.getDiv();
        // Fixa na tela pr√≥ximo ao clique
        div.style.left = (mapDiv.offsetLeft + (map.getDiv().offsetWidth/2) + ((pos.lng()-map.getCenter().lng())*scale*256/360)) + "px";
        div.style.top = (mapDiv.offsetTop + (map.getDiv().offsetHeight/2) - ((pos.lat()-map.getCenter().lat())*scale*256/180)) + "px";
        div.style.display = "flex";
      });
      // Esconde ao clicar fora
      google.maps.event.addListener(map, 'click', function(){div.style.display="none"});
    }
    function hideAllLabelBoxes() {
      labelBoxes.forEach(lb=>lb&&(lb.style.display="none"));
    }
    function updateLabelBoxes() {
      labelBoxes.forEach((lb,i)=>{
        if(lb){
          lb.querySelector("input").onchange = function(){
            overlays[i].name = lb.querySelector("input").value;
            saveAreas();
          }
        }
      });
    }
    // Anexa eventos para drag/delete ap√≥s load/cria√ß√£o
    function attachPolygonEvents(polygon, idx) {
      polygon.addListener("rightclick", function(e){
        // Exibe label box como se fosse click
        if(labelBoxes[idx]) labelBoxes[idx].style.display = "flex";
      });
      polygon.addListener('dragend', saveAreas);
      polygon.addListener('mouseup', saveAreas);
      polygon.addListener('path_changed', saveAreas);
    }
    // Google Maps callback
    function initMap() {
      // Sidebar/controles
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: -22.5162, lng: -44.0948},
        zoom: 15,
        mapTypeId: 'roadmap',
        streetViewControl: true,
        fullscreenControl: true,
      });
      // Relief (terrain) overlay
      reliefLayer = new google.maps.TerrainLayer();
      document.getElementById('reliefToggle').onchange = function() {
        if(this.checked) reliefLayer.setMap(map);
        else reliefLayer.setMap(null);
      }
      // Color picker
      document.getElementById('colorPicker').onchange = function() {
        colorSelected = this.value;
      };
      // Drawing Manager
      drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: null,
        drawingControl: false,
        polygonOptions: {
          editable: true,
          draggable: true,
          strokeColor: colorSelected,
          fillColor: colorSelected,
          fillOpacity: 0.16,
          strokeWeight: 2,
        }
      });
      drawingManager.setMap(map);

      document.getElementById('drawAreaBtn').onclick = function() {
        drawingManager.setDrawingMode('polygon');
        drawingManager.setOptions({
          polygonOptions: {
            editable: true,
            draggable: true,
            strokeColor: colorSelected,
            fillColor: colorSelected,
            fillOpacity: 0.16,
            strokeWeight: 2,
          }
        });
      };
      document.getElementById('clearBtn').onclick = function() {
        overlays.forEach(o=>o.polygon.setMap(null));
        overlays=[];
        labelBoxes.forEach(lb=>lb&&lb.remove());
        labelBoxes=[];
        saveAreas();
      };
      document.getElementById('mapBtn').onclick = function() {
        map.setMapTypeId('roadmap');
        this.classList.add('active');
        document.getElementById('satBtn').classList.remove('active');
      };
      document.getElementById('satBtn').onclick = function() {
        map.setMapTypeId('satellite');
        this.classList.add('active');
        document.getElementById('mapBtn').classList.remove('active');
      };

      google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon) {
        // Ao criar, solicita nome e encontra pol√≠gono pai (se houver)
        let latlngs = polygon.getPath().getArray();
        let parentIdx = getParentPolygonIdx(latlngs);
        overlays.push({polygon, name: "", color: colorSelected, parent: parentIdx});
        attachPolygonEvents(polygon, overlays.length-1);
        addPolygonLabelBox(polygon, "", colorSelected, overlays.length-1, parentIdx);
        saveAreas();
        drawingManager.setDrawingMode(null);
      });
      // Ao clicar fora do pol√≠gono, fecha bal√£o
      map.addListener('click', hideAllLabelBoxes);
      // Load persistidos
      loadAreas();
    }
  </script>
  <!-- Google Maps API + Drawing Library -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2Yir6fDl64yd4ddhLyBDkMIjpOYfpTmA&libraries=drawing&callback=initMap" async defer></script>
  <script>
    // Sidebar
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    menuToggle.addEventListener('click', function () {
      sidebar.classList.toggle('active');
    });
    document.addEventListener('click', function (e) {
      if (
        window.innerWidth <= 768 &&
        sidebar.classList.contains('active') &&
        !sidebar.contains(e.target) &&
        !menuToggle.contains(e.target)
      ) {
        sidebar.classList.remove('active');
      }
    });
  </script>
  <script src="darkmode.js"></script>
</body>
<footer class="footer">
  <div class="footer-content" style="display: flex; justify-content: space-between; align-items: center;">
    <div class="footer-logo-group">
      <img src="assets/syncnex-logo-64x64.png" alt="Logo SyncNex" class="footer-logo" />
      <div>
        <span class="footer-title">SyncNex &copy; 2025</span>
        <span class="footer-slogan">Conectando efici√™ncia ao seu neg√≥cio</span>
      </div>
    </div>
    <nav class="footer-nav">
      <a href="#">Sobre N√≥s</a>
      <a href="#">Contato</a>
      <a href="#">Pol√≠tica de Privacidade</a>
      <a href="#">Termos de Uso</a>
    </nav>
      <span class="versao">Vers√£o <b>V1.0.0</b></span>
    </div>
  </div>
</footer>
</html>
